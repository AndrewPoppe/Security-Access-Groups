<div class="modal fade userAlert" id="userExpirationModal" aria-labelledby="userExpirationTitle" data-backdrop="static"
    data-keyboard="false" aria-hidden="true">
    <div class="modal-lg modal-dialog modal-dialog-scrollable" id="userExpirationModalSecondary">
        <div class="modal-content">
            <div class="modal-header bg-danger text-light">
                <h5 class="modal-title" id="userExpirationTitle">Expire Project Users</h5>
                <button type="button" class="btn-close btn-danger align-self-center" data-bs-dismiss="modal"
                    data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userExpirationForm">
                    <!-- User Expiration Info -->
                    <div class="row mb-2 userExpirationListContainer">
                        <div class="col">
                            <div class="border bg-light">
                                <div class="row ml-4 mt-3 text-dangerrc">
                                    <h5><strong><i class="fa-solid fa-triangle-exclamation"></i> The following users
                                            will be expired in this project:</strong></h5>
                                </div>
                                <div class="form-group row ml-4 my-0">
                                    <table aria-label="users to be expired" id="userExpirationTable"
                                        class="table table-sm table-hover table-borderless w-50 ml-2">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #bdbdbd;">
                                                <th>REDCap Username</th>
                                                <th>Name</th>
                                                <th>Email Address</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <hr>
                                <div class="form-group row mx-3">
                                    <div class="col-sm-7">
                                        <div class="row">
                                            <label class="col-form-label col-form-label-sm">Set the number of days until
                                                the users are expired</label>
                                        </div>
                                        <div class="row">
                                            <span class="text-dangerrc">Choose a value of "0" to expire the users
                                                immediately</span>
                                        </div>
                                    </div>
                                    <div class="col-sm-5 mt-2">
                                        <input id="delayDays-expiration" name="delayDays-expiration" type="number"
                                            min="0" value="0" class="form-control form-control-sm">
                                        <div class="invalid-feedback">You must provide a number of days of at least 0
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- User Notification -->
                    <div class="row mb-2 userNotification">
                        <div class="col">
                            <div class="border bg-users p-4">
                                <div class="form-group row mb-0">
                                    <label class="col-sm col-form-label col-form-label-sm">Send Notification to
                                        User(s)?</label>
                                    <div class="col-sm">
                                        <div class="form-check">
                                            <input id="sendUserNotification" name="sendUserNotification" type="checkbox"
                                                class="form-check-input" value="1"
                                                onchange="$('#userNotificationInfo').collapse(this.checked ? 'show' : 'hide');">
                                            <label class="form-check-label" for="sendUserNotification">Yes, send a
                                                notification</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="collapse mt-2" id="userNotificationInfo">
                                    <div class="form-group row">
                                        <label for="fromEmail"
                                            class="col-sm-3 col-form-label col-form-label-sm">From:</label>
                                        <div class="col-sm-4">
                                            <input id="displayFromName-userExpiration" name="displayFromName"
                                                type="text" class="form-control form-control-sm"
                                                placeholder="Display name (optional)">
                                        </div>
                                        <div class="col-sm-5 pl-0">
                                            <select id="fromEmail-userExpiration" name="fromEmail"
                                                class="form-control form-control-sm">
                                                {{EMAIL_OPTIONS}}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="emailSubject-userExpiration"
                                            class="col-sm-3 col-form-label col-form-label-sm">Subject:</label>
                                        <div class="col-sm-9">
                                            <input id="emailSubject-userExpiration" name="emailSubject" type="text"
                                                class="form-control form-control-sm" required aria-required="true">
                                            <div class="invalid-feedback">You must provide a subject for the email</div>
                                        </div>
                                    </div>
                                    <div class="form-group row mb-1">
                                        <div class="col">
                                            <label for="emailBody-userExpiration"
                                                class="col-form-label col-form-label-sm">Email Body:</label>
                                            <textarea id="emailBody-userExpiration" name="emailBody" type="text"
                                                class="form-control form-control-sm richtext emailBody"></textarea>
                                            <div class="invalid-feedback">You must provide a body for the email</div>
                                        </div>
                                    </div>
                                    <div class="form-group row mb-1">
                                        <div class="col text-right">
                                            <button class="btn btn-info btn-xs" type="button"
                                                onclick="module.previewEmail($('#userExpirationForm .userNotification'));"><i
                                                    class="fa-eye fa-regular mr-1"></i>Preview</button>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-2" style="font-size: small;">
                                        <div class="col mx-3 p-2" style="background-color:#FFFFFF80;">
                                            <table aria-label="placeholders">
                                                <thead>
                                                    <tr>
                                                        <th colspan=2><span><strong>You can use the following
                                                                    placeholders
                                                                    to insert information into
                                                                    your email subject and body:</strong></span></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {{PLACEHOLDERS_USERS}}
                                                </tbody>
                                            </table>
                                            <p><span>You can also use <button
                                                        class="btn btn-xs btn-rcgreen btn-rcgreen-light"
                                                        style="margin-left:3px;font-size:11px;padding:0px 3px 1px;line-height:14px;"
                                                        onclick="smartVariableExplainPopup();setTimeout(function() {$('#smart_variable_explain_popup').parent().css('z-index', 1051);},300); return false;">[<i
                                                            class="fa-solid fa-bolt fa-xs" style="margin:0 1px;"></i>]
                                                        Smart Variables</button></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- User Rights Holders Notification -->
                    <div class="row userRightsHoldersNotification">
                        <div class="col">
                            <div class="border bg-userRightsHolders p-4">
                                <div class="form-group row mb-0">
                                    <label class="col-sm col-form-label col-form-label-sm">Send Notification to User
                                        Rights Holders?</label>
                                    <div class="col-sm">
                                        <div class="form-check">
                                            <input id="sendNotification-userExpiration-UserRightsHolders"
                                                name="sendNotification-userExpiration-UserRightsHolders" type="checkbox"
                                                class="form-check-input" value="1"
                                                onchange="userExpirationUserRightsHoldersToggle(this.checked);">
                                            <label class="form-check-label"
                                                for="sendNotification-userExpiration-UserRightsHolders">Yes, send a
                                                notification</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="collapse mt-2" id="notificationInfo-userExpiration-UserRightsHolders">
                                    <div class="form-group row">
                                        <label for="displayFromName-userExpiration-UserRightsHolders"
                                            class="col-sm-3 col-form-label col-form-label-sm">From:</label>
                                        <div class="col-sm-4">
                                            <input id="displayFromName-userExpiration-UserRightsHolders"
                                                name="displayFromName-userExpiration-UserRightsHolders" type="text"
                                                class="form-control form-control-sm"
                                                placeholder="Display name (optional)">
                                        </div>
                                        <div class="col-sm-5 pl-0">
                                            <select id="fromEmail-userExpiration-UserRightsHolders"
                                                name="fromEmail-userExpiration-UserRightsHolders"
                                                class="form-control form-control-sm">
                                                {{EMAIL_OPTIONS}}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="emailSubject-userExpiration-UserRightsHolders"
                                            class="col-sm-3 col-form-label col-form-label-sm">Subject:</label>
                                        <div class="col-sm-9">
                                            <input id="emailSubject-userExpiration-UserRightsHolders"
                                                name="emailSubject-userExpiration-UserRightsHolders" type="text"
                                                class="form-control form-control-sm">
                                            <div class="invalid-feedback">You must provide a subject for the email</div>
                                        </div>
                                    </div>
                                    <div class="form-group row mb-1">
                                        <div class="col">
                                            <label for="emailBody-userExpiration-UserRightsHolders"
                                                class="col-form-label col-form-label-sm">Email Body:</label>
                                            <div class="invalid-feedback">You must provide a body for the email</div>
                                            <textarea id="emailBody-userExpiration-UserRightsHolders" name="emailBody"
                                                type="text"
                                                class="form-control form-control-sm richtext emailBody"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group row mb-1">
                                        <div class="col text-right">
                                            <button class="btn btn-info btn-xs" type="button"
                                                onclick="module.previewEmailUserRightsHolders($('#userExpirationForm .userRightsHoldersNotification'));"><i
                                                    class="fa-eye fa-regular mr-1"></i>Preview</button>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-2" style="font-size: small;">
                                        <div class="col mx-3 p-2" style="background-color:#FFFFFFA0;">
                                            <table aria-label="placeholders">
                                                <thead>
                                                    <tr>
                                                        <th colspan=2><span><strong>You can use the following
                                                                    placeholders
                                                                    to insert information into
                                                                    your email subject and body:</strong></span></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {{PLACEHOLDERS_USER_RIGHTS_HOLDERS}}
                                                </tbody>
                                            </table>
                                            <p><span>You can also use <button
                                                        class="btn btn-xs btn-rcgreen btn-rcgreen-light"
                                                        style="margin-left:3px;font-size:11px;padding:0px 3px 1px;line-height:14px;"
                                                        onclick="smartVariableExplainPopup();setTimeout(function() {$('#smart_variable_explain_popup').parent().css('z-index', 1051);},300); return false;">[<i
                                                            class="fa-solid fa-bolt fa-xs" style="margin:0 1px;"></i>]
                                                        Smart Variables</button></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4 pl-0" id="expireUsersUserRightsHolderSelection">

                            <div class="mb-1" style="font-size: 14px;">
                                <strong>Select the recipients:</strong>
                            </div>
                            <table aria-label="alert recipients - user rights holders"
                                id="recipientTable_userExpiration_UserRightsHolders"
                                class="table table-sm table-bordered" style="font-size: 12px;">
                                <thead class="table-warning">
                                    <tr>
                                        <th scope="col"><input style="display:block; margin: 0 auto;" type="checkbox"
                                                class="selectAll" id="selectAllUserRightsHolders"
                                                onchange="$('.user-rights-holder-selector input').prop('checked', $(this).prop('checked')).trigger('change');">
                                        </th>
                                        <th scope="col">REDCap Username</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Email</th>
                                    </tr>
                                </thead>
                                <tbody class="word-wrap" style="word-wrap: anywhere;">
                                    {{USER_RIGHTS_HOLDERS}}
                                </tbody>
                            </table>
                            <div class="invalid-feedback">You must select at least one recipient</div>

                        </div>
                    </div>
                </form>
            </div>
            <div class=" modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"
                    data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="module.expireUsersAndSendAlerts();">Expire
                    Users</button>
            </div>
        </div>
    </div>
</div>
<script>
    $('#notificationInfo-UserRightsHolders').on('shown.bs.collapse', function () {
        if (!$('#sendNotification-UserRightsHolders').is(':checked')) $(this).collapse('hide');
    });
    $('#notificationInfo-UserRightsHolders').on('hidden.bs.collapse', function () {
        if ($('#sendNotification-UserRightsHolders').is(':checked')) $(this).collapse('show');
    });
    $('#userNotificationInfo').on('shown.bs.collapse', function () {
        if (!$('#sendUserNotification').is(':checked')) $(this).collapse('hide');
    });
    $('#userNotificationInfo').on('hidden.bs.collapse', function () {
        if ($('#sendUserNotification').is(':checked')) $(this).collapse('show');
    });
    $('#expireUsersUserRightsHolderSelection').on('shown.bs.collapsed', function () {
        if (!$('#sendNotification-userExpiration-UserRightsHolders').is(':checked')) $(this).collapse('hide');
    });
    $('#expireUsersUserRightsHolderSelection').on('hidden.bs.collapse', function () {
        if ($('#sendNotification-userExpiration-UserRightsHolders').is(':checked')) $(this).collapse('show');
    });

    function userExpirationUserRightsHoldersToggle(checked) {
        if (checked) {
            $('#notificationInfo-userExpiration-UserRightsHolders').collapse("show");
            $('#expireUsersUserRightsHolderSelection').show();
            $('#userExpirationModalSecondary').addClass("modal-xl").removeClass("modal-lg");
            $('div.row.userExpirationListContainer > div.col').addClass('col-8').removeClass('col');
            $('div.row.userNotification > div.col').addClass('col-8').removeClass('col');
        } else {
            $('div.row.userExpirationListContainer > div.col-8').addClass('col').removeClass('col-8');
            $('div.row.userNotification > div.col-8').addClass('col').removeClass('col-8');
            $('#expireUsersUserRightsHolderSelection').hide();
            $('#notificationInfo-userExpiration-UserRightsHolders').collapse("hide");
            $('#userExpirationModalSecondary').addClass("modal-lg").removeClass("modal-xl");
        }

    }
</script>