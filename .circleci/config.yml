version: 2.0

jobs:
  run-test:
    docker:
      image: mcr.microsoft.com/playwright:v1.37.0-jammy
    steps:
      - checkout
      - run: npm install
      - run: npx playwright install
      - run: npx playwright install chromium
      - run:
          name: Install MySQL Client
          command: |
            apt-get update
            apt-get install mysql-client-core-8.0
      - run:
          name: Install docker-compose
          command: |
            apt-get update
            apt-get install ca-certificates curl gnupg
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
              tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      - run:
          name: Build the REDCap Image
          command: |
            git clone --branch v11.1.29 https://github.com/aldefouw/redcap_docker
      - run:
          name: Get REDCap Source
          command: |
            git clone --branch v13.1.27 https://github.com/AndrewPoppe/redcap_source www
      - run:
          name: Start Docker REDCap Container
          command: |
            cd /root/project/redcap_docker
            docker compose up -d
      - run:
          name: Change eDocs folder permissions
          command: |
            chmod 777 /var/edocs              
      - run:
          name: Run Tests
          command: |
            npx playwright test
workflows:
  version: 2
  workflow:
    jobs:
    - run-test:
        context: REDCap Tests