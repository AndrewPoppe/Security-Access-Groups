= Security Access Groups
Andrew Poppe <andrew.poppe@yale.edu>
:description: This is an External Module for REDCap that allows admins to create and manage Security Access Groups that restrict which User Rights a user may be granted.
:imagesdir: docs/images
:sectlinks: true
:table-stripes: odd
:toc:
:toc-placement!:
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

image:https://sonarcloud.io/api/project_badges/measure?project=AndrewPoppe_Security-Access-Groups&metric=alert_status[link="https://sonarcloud.io/summary/new_code?id=AndrewPoppe_Security-Access-Groups"]

toc::[]

== Introduction

This External Module allows REDCap administrators to create and manage Security Access Groups in a REDCap system.

*Security Access Groups* (SAGs) are used to restrict which user rights a REDCap user can be granted in a project. SAGs do not define the rights a user will have in a given project; rather, they define the set of allowable rights the user is able to be granted. SAGs are defined at the system level and are used in any project that has this module enabled.

For example, if your institution requires documentation of training for users to export data, you can create a SAG that does not allow the "Data Export Tool" User Right to be granted to users assigned it. Once a user completes training, they can be moved to a SAG that does allow the "Data Export Tool" User Right to be granted.

To accomplish this, REDCap administrators first create SAGs using a <<security_access_groups_tab, menu>> in the Control Center. Once a SAG is created, users can be assigned to it in a separate <<users_tab, tab>> the same control center menu. When a user is assigned to a SAG, the user will only be able to be granted User Rights that are allowed by the SAG.

IMPORTANT: The module must be enabled in a project for it to restrict User Rights in that project. It is recommended that the module be enabled in all projects.

When the module is enabled in a project, it will check which rights are allowable for a user according to their SAG before granting any user rights to that user. The module intercepts all attempts to set user rights in a project, including

* Using the usual methods on the User Rights project page
* Using the `Upload users, role, and assignments` feature on the User Rights project page
* Using the REDCap API

*All attempts to set user rights will be blocked if the user is not allowed to be granted the rights according to their SAG.* Attempts to circumvent the module are detected and logged.

.Example of a user being blocked from being granted a User Right
image::p_blocked_2.png[blocked]


== Module Configuration

.EM Framework Config Options
image::cc_config_2.png[config]

The control center module configuration page allows admins to set the following options at the system level.

NOTE: <<placeholders, Placeholders>> may be used in any of these default settings.

[#config_options]
.EM Framework Management Config Options
[%header,cols="1,2,1,3"]
|===
|Section
|Option
|Type
|Description

.4+.^a|User Alert Email Settings
|User Alert Email Default Subject
|Text
|The default subject for emails sent to users.

|User Alert Email Default Body
|Rich Text
|The default body for emails sent to users.

|User Reminder Alert Email Default Subject
|Text
|The default subject for reminder emails sent to users.

|User Reminder Email Default Body
|Rich Text
|The default body for reminder emails sent to users.

.4+.^|User Rights Holder Alert Email Settings
|User Rights Holders Alert Email Default Subject
|Text
|The default subject for emails sent to user rights holders.

|User Rights Holders Alert Email Default Body
|Rich Text
|The default body for emails sent to user rights holders.

|User Rights Holders Reminder Alert Email Default Subject
|Text
|The default subject for reminder emails sent to user rights holders.

|User Rights Holders Reminder Alert Email Default Body
|Rich Text
|The default body for reminder emails sent to user rights holders.

.4+.^|User Expiration Alert Email Settings
|User Expiration Alert Email Default Subject
|Text
|The default subject for emails sent to users upon expiration.

|User Expiration Alert Email Default Body
|Rich Text
|The default body for emails sent to users upon expiration.

|User Rights Holders Alert Email Default Subject
|Text
|The default subject for emails sent to user rights holders upon expiration.

|User Rights Holders Alert Email Default Body
|Rich Text
|The default body for emails sent to user rights holders upon expiration.
|===

== Control Center Page

[#users_tab]
=== Users Tab

.Users tab
image::cc_users_2.png[users]

This tab allows admins to assign users to SAGs. Users can be assigned to SAGs individually or in bulk using the `Import User Assignments` feature (see <<import_file_format, Import File Format>>).

.User assignment
image::cc_users_edit_2.png[users assign]

.Users actions
image::cc_users_actions_2.png[users actions]

[#import_file_format]
==== Import File Format

[horizontal]
username:: The REDCap username of the user
sag_id:: The SAG ID of the SAG to assign the user to. SAG IDs can be found on the <<security_access_groups_tab>> of the module.

The file used to import user assignments must be a CSV file with the following columns:
[%header,cols="1,2"]
|===
|Column header
|Description

|username
|The REDCap username of the user

|sag_id
|The SAG ID of the SAG to assign the user to. SAG IDs can be found on the <<security_access_groups_tab>> of the module.
|===

You can download a template import file using the dropdown in the menu or use the export file as a guide.

.Confirmation popup of SAG assignment import
image::cc_user_import_confirm_2.png[user import confirm]

[#security_access_groups_tab]
=== Security Access Groups Tab

.Security Access Groups tab
image::cc_sags_2.png[sags]

This tab shows all SAGs that exist in the system. SAGs can be created, edited, and deleted from this tab. Click a SAG's name to edit it.

TIP: You can also *Copy* and *Delete* the SAG from the editor popup.

.SAG editor
image::cc_sags_editor_2.png[sags edit]

SAGs can also be created or edited in bulk by importing a CSV file using the dropdown options in the menu. See the <<sag_import_file_format, SAG Import File Format>> for more information.

.SAG dropdown options
image::cc_sags_actions_2.png[sags actions]

[#sag_import_file_format]
==== SAG Import File Format

The file used to import SAGs must be a CSV file with the following columns:
[%header,cols="1,3,4"]
|===
|Column header
|Description / The User Right that is restricted
|Possible values

.^|sag_name
.^|The display name of the SAG
.^a| The text of the SAG name

.^|sag_id
.^|If you are editing an existing SAG, this is the SAG ID of the SAG to edit. If you are creating a new SAG, this column should be left blank.
.^a| The text of the SAG ID

.^|design
.^|Project Design and Setup
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|user_rights
.^|User Rights
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_access_groups
.^|Data Access Groups
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|dataViewing
.^|Data Viewing Rights
.^a|

* `0` - Only _No access_ is allowed
* `1` - _No access_ and _Read only_ are allowed
* `2` - _No access_, _Read only_, and _View & Edit_ are allowed
* `3` - All data viewing rights settings are allowed

.^|dataExport
.^|Data Export Rights
.^a|

* `0` - Only _No access_ is allowed
* `1` - _No access_ and _De-Identified_ are allowed
* `2` - _No access_, _De-Identified_, and _Remove All Idenitifier Fields_ are allowed
* `3` - All data export rights settings are allowed

.^|alerts
.^|Alerts & Notifications
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|reports
.^|Reports & Report Builder
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|graphical
.^|Stats & Charts
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|participants
.^|Survey Distribution Tools
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|calendar
.^|Calendar & Scheduling
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_import_tool
.^|Data Import Tool
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_comparison_tool
.^|Data Comparison Tool
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_logging
.^|Logging
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|file_repository
.^|File Repository
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|lock_record_customize
.^|Record Locking Customization
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|lock_record
.^|Lock/Unlock Records
.^a|

* `0` - Only _Disabled_ is allowed
* `1` - _Disabled_ and _Locking / Unlocking_ are allowed
* `2` - All record locking settings are allowed

.^|data_quality_design
.^|Data Quality (create/edit rules)
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_quality_execute
.^|Data Quality (execute rules)
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|mobile_app
.^|REDCap Mobile App
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|mobile_app_download_data
.^|Allow user to download data for all records to the app?
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|realtime_webservice_mapping
.^|CDP/DDP Setup / Mapping
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|realtime_webservice_adjudicate
.^|CDP/DDP Adjudicate Data
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|dts
.^|DTS (Data Transfer Services)
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|mycap_participants
.^|Manage MyCap Participants
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|record_create
.^|Create Records
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|record_rename
.^|Rename Records
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|record_delete
.^|Delete Records
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|random_setup
.^|Randomization - Setup
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|random_dashboard
.^|Randomization - Dashboard
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|random_perform
.^|Randomization - Randomize
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_quality_resolution_view
.^|Data Quality Resolution - View Queries
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_quality_resolution_open
.^|Data Quality Resolution - Open Queries
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_quality_resolution_respond
.^|Data Quality Resolution - Respond to Queries
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|data_quality_resolution_close
.^|Data Quality Resolution - Close Queries
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|double_data_reviewer
.^|Double Data Entry - Reviewer
.^a|

* `0` - Not allowed to be a reviewer
* `1` - Allowed

.^|double_data_person
.^|Double Data Entry - Person
.^a|

* `0` - Not allowed to be either Person #1 or Person #2
* `1` - Allowed

.^|api_export
.^|API Export
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|api_import
.^|API Import/Update
.^a|

* `0` - Not allowed
* `1` - Allowed

.^|lock_record_multiform
.^|Lock/Unlock \*Entire* Records (record level)
.^a|

* `0` - Not allowed
* `1` - Allowed
|===


[#user_rights_holders_tab]
[#reports_tab]
=== Reports Tab

.Reports tab
image::cc_report_types_2.png[reports]

This tab provides an easy way to see all users in the system that currently have user rights that do not comply with their current SAG. This can occur when the module is first enabled in a project or when a user is assigned to a new SAG.

The report options are as follows:

[#reports_table]
[%header,cols="1,3"]
|===
|Report title
|Description

|Users with Noncompliant Rights (non-expired)
|This report lists all users who are assigned to a SAG that does not allow the user to be granted all of the rights they currently have in a project. This report only includes users if they are not currently expired in the project(s).

|Users with Noncompliant Rights (all)
|This report lists all users who are assigned to a SAG that does not allow the user to be granted all of the rights they currently have in a project. This report includes all users, regardless of whether they are currently expired in the project(s).

|Projects with Noncompliant Rights (non-expired)
|This report lists all projects that have at least one user who is assigned to a SAG that does not allow the user to be granted all of the rights they currently have in the project. This report only includes users who have a non-expired user account.

|Projects with Noncompliant Rights (all)
|This report lists all projects that have at least one user who is assigned to a SAG that does not allow the user to be granted all of the rights they currently have in the project. This report includes all users, regardless of whether their user account is expired.

|Users and Projects with Noncompliant Rights (non-expired)
|This report lists every user and project combination in which the user is assigned to a SAG that does not allow the user to be granted all of the rights they currently have in the project. This report only includes users who are not currently expired in the project.

|Users and Projects with Noncompliant Rights (all)
|This report lists every user and project combination in which the user is assigned to a SAG that does not allow the user to be granted all of the rights they currently have in the project. This report includes all users, regardless of whether they are currently expired in the project.
|===

.Report example
image::cc_report_example_2.png[report example]


[#project_page]
== Project Page

[#project_status_tab]
=== Project Status Tab

.Project status tab
image::p_status_2.png[project status]

.Alert user
image::p_status_alert_user_2.png[alert user]

.Remind user
image::p_status_alert_user_reminder_2.png[remind user]

.Alert user rights holders
image::p_status_alert_user-rights-holder_2.png[alert user rights holders]

.Remind user rights holders
image::p_status_alert_user-rights-holder_reminder_2.png[remind user rights holders]

.Expire users
image::p_status_expiration_2.png[expire users]

.Alert users upon expiration
image::p_status_expiration_alert_user_2.png[alert users upon expiration]

.Alert user rights holders upon expiration
image::p_status_expiration_alert_user-rights-holder_2.png[alert user rights holders upon expiration]

[#placeholders]
==== Placeholders

The following placeholders can be used in the email subject and body fields in alerts:

[%header,cols="2,1,4"]
|===
|Placeholder
|Audience
|Description

.^a|`[sag-user]`
.^|Project User
| The user's username

.^a|`[sag-user-fullname]`
.^|Project User
|The user's full name

.^a|`[sag-user-email]`
.^|Project User
|The user's email address

.^a|`[sag-rights]`
.^|Project User
|A formatted list of the rights that do not
conform with the user's security access group.

.^a|`[sag-project-title]`
.^|Any
|The title of the project

.^a|`[sag-users]`
.^|User Rights Holders
|A formatted list of usernames

.^a|`[sag-user-fullnames]`
.^|User Rights Holders
|A formatted list of users' full names

.^a|`[sag-user-emails]`
.^|User Rights Holders
|A formatted list of user emails

.^a|`[sag-users-table]`
.^|User Rights Holders
|A formatted table of usernames, full names, and email addresses

.^a|`[sag-users-table-full]`
.^|User Rights Holders
|A formatted table of usernames, full names, email addresses, and non-compliant rights

|===

TIP: You can also use any REDCap Smart Variables, although few will be relevant in this context.


[#user_rights_tab]

[#alert_log_tab]
=== Alert Log Tab

.Alert log tab
image::p_alert_log_2.png[alert log]


.Alert preview example
image::p_logs_preview_2.png[alert preview]

[#logging]
== Logging
